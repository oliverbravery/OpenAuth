# API Endpoints
_This document contains descriptions of the API endpoints of the OpenAuth API._

Table of Contents:
- [Open Auth](#open-auth)
    - [Authentication routes (/authentication)](#authentication-routes-authentication)
        - [GET /authentication/authorize](#get-authenticationauthorize)
        - [POST /authentication/token](#post-authenticationtoken)
    - [Account routes (/account)](#account-routes-account)
        - [POST /account/register](#post-accountregister)
        - [GET /account/login](#get-accountlogin)
        - [GET /account/\<username\>](#get-accountusername)
        - [PATCH /account/\<username\>](#patch-accountusername)
    - [Developer routes (/developer)](#developer-routes-developer)
        - [POST /developer/enroll](#post-developerenroll)
        - [POST /developer/add_client](#post-developeradd_client)
    - [Well Known (/.well-known)](#well-known-well-known)
        - [GET /.well-known/jwks.json](#get-well-knownjwksjson)

## Open Auth
The _Open Auth API_ is responsible for handling user authentication and authorisation. The service provides endpoints for user registration, user authentication and user information update and retreival.

> **NOTE** - The endpoints described here are the public endpoints. There are more endpoints that are used internally by the service to handle the OAuth2.0 Authorization Code Flow with PKCE however these are not described here as they are not intended to be accessed by the client.

### Authentication routes (/authentication)
The authentication routes are responsible for handling user authentication and authorisation. The authentication service follows the OAuth2.0 Authorization Code Flow with Proof Key for Code Exchange (PKCE) standard [(RFC 7636)](https://datatracker.ietf.org/doc/html/rfc7636#section-1.1). 

#### GET /authentication/authorize
> _Used for user login and consent. Contains logic to register/link a user's account with a client (application)._

This route is used to initiate the OAuth2.0 Authorization Code Flow with PKCE.

It will redirect the user to the login page so that they can enter their login credentials. After the user logs in successfully, they will be redirected automatically to the consent page. The consent page will display the requested scopes and ask the user to approve or deny the request. Apon success, the user will be redirected to the redirect url registered with the client alongside an authorization code (as stated in [RFC 7636](https://datatracker.ietf.org/doc/html/rfc7636)).

##### Query Parameters:
- client_id (str): The id of the application. Used to know which application is requesting access.
- client_secret (str): The secret of the application. Used to authenticate the application.
- scope (str): The list of requested scopes as a space-separated string.
- response_type (str): The type of response. Should be '_code_' for the authorization code flow.
- state (str): A random string generated by the client. Used to prevent CSRF attacks. Returned in the response.
- code_challenge (str): The code challenge generated by the client. Used by PKCE to prevent code interception attacks.

##### Response:
Successful response: After the user logs in and consents, they will be redirected to the redirect_uri of the client in the query parameters with:
- code (str): The authorization code needed for obtaining a token (in redirect URI query parameters).
- state (str): The unaltered state parameter from the request (in redirect URI query parameters). Used to prevent CSRF attacks.

Unsuccessful response: If the user fails to login or consent to the request or if there is an error, an error message will be returned alongside a non-positive status code.

#### POST /authentication/token
> _Used to exchange the authorization code for an access token OR to refresh an access token._

This route is used to exchange the authorization code for an access token or to refresh an access token. The route follows the OAuth2.0 Authorization Code Flow with PKCE.

For exchanging the authorization code for an access token, the route will verify that the given code is valid then generate a new access token and refresh token based on the scopes the user consented to (when generating the authorization code).

For refreshing the access token with the refresh token, the route will check that the refresh token is valid and generate a new access token and refresh token based on the scopes the user consented to (when generating the refresh token).

##### Query Parameters:
- grant_type (str): The type of grant. Should be 'authorization_code' for the authorization code flow or 'refresh_token' for refreshing the access token.
- client_id (str): The id of the application. Used to know which application is requesting access.
- client_secret (str): The secret of the application. Used to authenticate the application.
- code (str): The authorization code generated by the auth service. If generating a refresh token leave this field as an empty string.
- code_verifier (str): The code verifier generated by the client. Used by PKCE to prevent code interception attacks.
- refresh_token (str, optional): The refresh token generated by the auth service. Used to get a new access token. If generating an access token leave this field as an empty string.

##### Response:
Successful response (HTTP_200_OK): If the request is successful, the response will be a JSON containing the following fields:
- access_token (str): The access token generated by the auth service.
- expires_in (int): The time in seconds for the token to expire.
- refresh_token (str): The refresh token generated by the auth service.
- token_type (str, optional): The type of the token. Defaults to "Bearer".

Unsuccessful response (HTTP_401_UNAUTHORIZED | HTTP_500_INTERNAL_SERVER_ERROR): If the request is unsuccessful, an error message will be returned alongside a non-positive status code.

> **NOTE** - Refresh token rotation is implemented. This means that when a new refresh token is generated or an old verifed refresh token is used, the current refresh token will be invalidated. This is to prevent replay attacks. Read more about refresh token rotation [here](https://auth0.com/docs/secure/tokens/refresh-tokens/refresh-token-rotation).

### Account routes (/account)
The account routes are responsible for handling user account information. The account routes allow for user registration, user information update and user information retrieval. 

#### GET /account/register
> _Used to register a new user account._

This route is used to register a new user account. It will redirect you to a webpage to enter the user's information. The user's information will be validated and if successful, the user will be added to the database.

##### Response:
Successful response (HTTP_200_OK): If the request is successful, the user will be added to the database and an appropriate message will be returned.

#### GET /account/login
> _Used to login a user to the authentication service (default client). Nessasary to allow users to create their own clients._

This route is used to login a user to the authentication service client (the default client for the authentication service). The route redirect to the login page followed by the consent page and finally return an access and refresh token with scopes to the default client. Wraps the [`/authentication/authorize`](#get-authenticationauthorize) and [`/authentication/token`](#post-authenticationtoken) routes.

##### Query Parameters:
 - None 

##### Response:
Successful response (HTTP_200_OK): If the request is successful an access and refresh token will be returned with no scopes (related to the default client) as a JSON with the following fields:
- access_token (str): The access token.
- refresh_token (str): The refresh token. 

Unsuccessful response (HTTP_400_BAD_REQUEST | HTTP_403_FORBIDDEN | HTTP_401_UNAUTHORIZED | HTTP_409_CONFLICT | HTTP_500_INTERNAL_SERVER_ERROR): If the request is unsuccessful, an error message will be returned alongside a non-positive status code.

#### GET /account/\<username\>
> _Used to get the user information for a given \<username\>._

This route is used to get information from a user account based on the given username in the URL. The requesting user is validated by the access token in the request header. The scopes of the access token are used to check what data to return. The account of the username in the URL must be registered with the same client as the client_id in the access token's audience field (the client used to generate the access token).

##### Authorization:
- Bearer Token (str): The access token.

##### Response:
Successful response (HTTP_200_OK): If the request is successful the user information will be returned as a JSON. The keys of the JSON will be the attributes of the user account in the format \<client_id\>.\<attribute_name\> and the values will be the values of the attributes.

Unsuccessful response (HTTP_401_UNAUTHORIZED | HTTP_403_FORBIDDEN | HTTP_404_NOT_FOUND | HTTP_500_INTERNAL_SERVER_ERROR): If the request is unsuccessful, an error message will be returned alongside a non-positive status code.

#### PATCH /account/\<username\>
> _Used to update the user information for a given \<username\>._

This route is used to update information from a user account based on the given username in the URL. The access token scopes are used to check that the requesting user has the correct permissions to update the user information for the given user. The account of the username in the URL must be registered with the same client as the client_id in the access token's audience field (the client used to generate the access token). 

##### Authorization:
- Bearer Token (str): The access token.

##### Body:
- attributes to update (JSON): A JSON (dict[str: any]) representation of the attributes to update mapped to their new value. The attribute name should be in the following format: \<client_id\>.\<attribute_name\>.

##### Response:
Successful response (HTTP_200_OK): If the request is successful the user information will be updated and a success message will be returned.

Unsuccessful response (HTTP_401_UNAUTHORIZED | HTTP_403_FORBIDDEN | HTTP_404_NOT_FOUND | HTTP_500_INTERNAL_SERVER_ERROR): If the request is unsuccessful, an error message will be returned alongside a non-positive status code.

### Developer routes (/developer)
The developer routes are responsible for enrolling accounts as developers alongside creating clients. A account must be enrolled as a developer to create a client for example.

#### POST /developer/enroll
> _Used to enroll a user as a developer._

This route is used to enroll a user as a developer. The route will check that the user is not already enrolled as a developer then enroll the user as a developer. 

##### Authorization:
- Bearer Token (str): The access token. The access token is used to identify the user to enroll as a developer.

##### Response:
Successful response (HTTP_200_OK): If the request is successful the user will be enrolled as a developer and an appropriate message will be returned.

Unsuccessful response (HTTP_500_INTERNAL_SERVER_ERROR): If the request is unsuccessful, an error message will be returned alongside a non-positive status code.

#### POST /developer/add_client
> _Used to create (register) a new client._

This route is used to create a new client. The route will check that the user is enrolled as a developer, check that the given client structure is valid and then create the client.

> **NOTE** - The route will generate a client_id and client_secret for the client as these must be unique. The client_id and client_secret will be returned in the response.

##### Authorization:
- Bearer Token (str): The access token. The access token is used to identify the user to create the client for. The user must be [registered as a developer](#post-developerenroll).

##### Body:
- The class model (JSON): A JSON (dict[str: any]) representation of the client to create. To see a more indepth description of the model, see the source code for the [ClientRegistrationForm](../auth_service/models/form_models.py). The client should have the following attributes:
    - client_name (str): The name of the client to register.
    - client_description (str): A description of the client used in the consent page.
    - client_redirect_uri (str): The URI to which the user is redirected after granting or denying access to the client.
    - client_developers (list[[ClientDeveloper](/models/client_models.py)]): The developers that have access to the client along with the scopes they have access to. The scopes must be 'developer_only'.
    - scopes (list[[ClientScope](/models/scope_models.py)]): The client specific scopes and what attributes each scope can control. For more information about the structure of the ClientScope object see the [source code](/models/scope_models.py).
    - client_profile_metadata_attributes (list[[MetadataAttribute](/models/client_models.py)]): The metadata attributes that the client can store in the user's profile.
    - client_profile_defaults (dict[str, any]): The default values for the metadata attributes that the client can store in the user's profile.
    - shared_read_attributes (list[[AccountAttribute](/models/scope_models.py)]): The shared attributes that the client and other linked accounts can read from the user's account. 

##### Response:
Successful response (HTTP_200_OK): If the request is successful the client will be created and the 'client_id' and 'client_secret' will be returned in a JSON ({'client_id': str, 'client_secret': str}). The 'client_id' is the id of the client and the 'client_secret' is the secret of the client.

Unsuccessful response (HTTP_400_BAD_REQUEST | HTTP_500_INTERNAL_SERVER_ERROR): If the request is unsuccessful, an error message will be returned alongside a non-positive status code.

### Well Known (/.well-known)
A standardised endpoint for getting information such as the public key for the authentication service used to verify JWTs.

#### GET /.well-known/jwks.json
> _Used to get the public key for the authentication service._

This route is used to get the public key for the authentication service. The public key is used to verify the JWTs generated by the authentication service.

##### Response:
Returns a standard JWK dict representing the public key for verifying JWT tokens.